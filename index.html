<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sojo Meta Spatial Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="background-glow"></div>

    <header class="site-header">
        <div class="container">
            <h1>Sojo Meta Spatial Studio</h1>
            <p class="subtitle">å´‡åŸå¤§å­¦ ãƒ¡ã‚¿ç©ºé–“ã‚¹ã‚¿ã‚¸ã‚ª ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</p>
        </div>
    </header>

    <main class="container">
        <section class="gallery">
            <article class="video-card">
                <div class="video-wrapper" id="scene-container">
                    <!-- Three.js Canvas will be injected here -->
                    <div id="loading-overlay">
                        <div class="spinner"></div>
                        <p>Loading 3D Engine...</p>
                    </div>
                    <button id="start-vr-btn" class="vr-overlay-btn" style="display: none;">
                        <span class="icon">ğŸ“±</span> ã‚¸ãƒ£ã‚¤ãƒ­æ“ä½œã‚’é–‹å§‹
                    </button>
                </div>
                <div class="card-content">
                    <h2>3Dã‚¢ãƒ¼ãƒˆã‚³ãƒ¼ã‚¹ ä½œå“ç´¹ä»‹</h2>
                    <p>ãƒ¡ã‚¿ç©ºé–“ã‚¹ã‚¿ã‚¸ã‚ªã§åˆ¶ä½œã•ã‚ŒãŸã€æ²¡å…¥æ„Ÿã‚ãµã‚Œã‚‹3Dã‚¢ãƒ¼ãƒˆã®ä¸–ç•Œè¦³ã‚’ã”è¦§ãã ã•ã„ã€‚<br>ãƒ‰ãƒ©ãƒƒã‚°ã¾ãŸã¯ç«¯æœ«ã‚’å‹•ã‹ã—ã¦è¦–ç‚¹ã‚’æ“ä½œã§ãã¾ã™ã€‚</p>

                    <div class="local-file-upload">
                        <p class="note">â€»å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã„å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦å†ç”Ÿã§ãã¾ã™</p>
                        <label for="video-upload" class="upload-btn">
                            å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </label>
                        <input type="file" id="video-upload" accept="video/mp4,video/webm" style="display: none;">
                    </div>
                </div>
            </article>

            <!-- Future videos can be added here -->
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2026 Sojo Meta Spatial Studio. All rights reserved.</p>
        </div>
    </footer>

    <!-- Three.js Libraries -->
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.7.0/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.154.0",
                "three/addons/": "https://esm.sh/three@0.154.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { DeviceOrientationControls } from 'three/addons/controls/DeviceOrientationControls.js';

        let camera, scene, renderer, controls;
        let video, videoTexture;
        let isDeviceOrientationActive = false;

        const container = document.getElementById('scene-container');
        const startVrBtn = document.getElementById('start-vr-btn');
        const fileInput = document.getElementById('video-upload');
        const loadingOverlay = document.getElementById('loading-overlay');

        init();
        animate();

        function init() {
            // Setup Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111);

            // Setup Camera
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 0.1); // Slightly offset to ensure we are inside

            // Setup Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // Setup Video Element (Hidden)
            video = document.createElement('video');
            video.crossOrigin = "anonymous";
            video.loop = true;
            video.muted = true; // Mute by default to allow autoplay
            video.playsInline = true;
            video.src = "SampleVideo/3D%E3%82%A2%E3%83%BC%E3%83%88%E3%82%B3%E3%83%BC%E3%82%B9%201.mp4";
            video.load();

            // Auto play attempt
            video.play().then(() => {
                loadingOverlay.style.display = 'none';
            }).catch(e => {
                console.log("Autoplay blocked, waiting for interaction");
                loadingOverlay.querySelector('p').textContent = "Click to Start";
                container.addEventListener('click', () => {
                    video.play();
                    video.muted = false;
                    loadingOverlay.style.display = 'none';
                }, { once: true });
            });

            // Create Video Texture
            videoTexture = new THREE.VideoTexture(video);
            videoTexture.colorSpace = THREE.SRGBColorSpace;

            // Create Room (Box) Geometry
            // Size 10x10x10, inverted by using BackSide material to view from inside
            const geometry = new THREE.BoxGeometry(20, 10, 20); // Width, Height, Depth
            const material = new THREE.MeshBasicMaterial({
                map: videoTexture,
                side: THREE.BackSide
            });
            const room = new THREE.Mesh(geometry, material);
            scene.add(room);

            // Initial Controls (Orbit for Desktop)
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableZoom = false;
            controls.enablePan = false;
            controls.rotateSpeed = -0.5; // Invert rotation for "looking around" feel

            // Handle Resize
            window.addEventListener('resize', onWindowResize);

            // Check if mobile for VR button
            if (isMobile()) {
                startVrBtn.style.display = 'flex';
                startVrBtn.addEventListener('click', enableDeviceOrientation);
            }
        }

        function onWindowResize() {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            renderer.render(scene, camera);
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        async function enableDeviceOrientation() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+
                try {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState === 'granted') {
                        activateOrientationControls();
                    } else {
                        alert('Permission denied');
                    }
                } catch (error) {
                    console.error(error);
                }
            } else {
                // Non-iOS or older devices
                activateOrientationControls();
            }
        }

        function activateOrientationControls() {
            controls.dispose(); // Remove orbit controls
            controls = new DeviceOrientationControls(camera);
            isDeviceOrientationActive = true;
            startVrBtn.style.display = 'none';
        }

        // Local File Handling
        fileInput.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const fileURL = URL.createObjectURL(file);
                video.src = fileURL;
                video.load();
                video.play();
            }
        });
    </script>

</html>